<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>陽明山青商會-會員通訊錄</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
  <h2 style="text-align: center;">陽明山青商會-會員通訊錄</h2>
  <div id="memberList">
    <div class="list-r list-h">
            <div class="list-name">
                姓名
            </div>
            <div class="list-com">服務單位</div>
            <div class="list-tel">行動電話</div>
            <div class="list-addr">地址</div>
            <div class="list-email">E-mail</div>
            <div class="list-line">LINE</div>
        </div>
  </div>
  <div id="pagination"></div>
<script src="config.js"></script> 
  <script>
    const pageSize = 10;
    let currentPage = 1;
    let members = [];

    // 輔助函式：將 JS 物件轉換為 URL 查詢字串
    function encodeData(data) {
        return Object.keys(data).map(key => 
            encodeURIComponent(key) + '=' + encodeURIComponent(data[key])
        ).join('&');
    }

    async function fetchMembers() {
      // 📌 核心修正：改用 GET 請求，並將 action 參數放入 URL 中
      const payload = { 
          action: "getList",
          // 💡 為了後續處理，這裡應該要加入您在登入時儲存的 token
          token: localStorage.getItem('userToken') 
      };
      
      const fullUrl = GAS_URL + '?' + encodeData(payload);

      try {
        // 🚀 使用 GET 請求 (這是 GAS doGet 函式最穩定的接收方式)
        const resp = await fetch(fullUrl, { method: "GET" });
        
        if (!resp.ok) {
            throw new Error(`HTTP 錯誤狀態: ${resp.status}`);
        }
        
        const result = await resp.json();
        
        // 檢查 GAS 回傳的 success 狀態 (這一步非常重要，因為我們知道您的 GAS 會回傳結構化的 JSON)
        if (result.success && result.list) {
            members = result.list;
            renderPage(currentPage);
        } else if (result.msg) {
             // 處理未授權或伺服器回傳的錯誤訊息
             document.getElementById("memberList").textContent = "錯誤: " + result.msg;
             
             // 💡 額外處理：如果未授權，跳回登入頁
             if (result.msg.includes("未授權")) { 
                 alert("會話過期或未登入，請重新登入！");
                 window.location.href = "login.html";
             }
        } else {
            throw new Error("伺服器回傳格式錯誤或未提供清單。");
        }
        
      } catch(err) {
        // 處理網路錯誤或解析錯誤
        document.getElementById("memberList").textContent = "資料載入失敗: " + err.message;
        console.error(err);
      }
    }

   // 替換您 list.html 中的 renderPage(page) 函式
function renderPage(page) {
    const listDiv = document.getElementById("memberList");
    listDiv.innerHTML = "";

    const start = (page - 1) * pageSize;
    const end = start + pageSize;
    const pageItems = members.slice(start, end);

    pageItems.forEach(member => {
        // 1. 獲取唯一的識別碼（電話號碼），用於傳遞給 personal.html
        const phone = member["行動電話-帳"] || ''; // 確保是空字串而不是 null/undefined
        
        // 2. 檢查 "歿" 欄位，如果它有值，則在姓名後加 *
        const isDeceased = member["歿"] && String(member["歿"]).trim() !== '';
        const nameText = member["姓名"] || 'N/A';
        const nameDisplay = nameText + (isDeceased ? '*' : '');
        
        // 輔助函式：確保 N/A 或空值不顯示 N/A，留給 CSS 控制
        const getValue = (key) => member[key] || ' ';
        
        // 🚀 關鍵修正：簡化結構，並加入 CSS Class
        const div = document.createElement("div");
        div.className = "list-r"; // 頂層 div 的 class

        // 💡 內層使用 innerHTML 拼接，減少 DOM 操作
        div.innerHTML = `
            <div class="list-name ${isDeceased ? 'deceased-member' : ''}">
                <a href="personal.html?phone=${encodeURIComponent(phone)}">
                    姓名: ${nameDisplay}
                </a>
            </div>
            <div class="list-com">${getValue("服務單位")}</div>
            <div class="list-tel">${getValue("行動電話-帳")}</div>
            <div class="list-addr">${getValue("通訊地址")}</div>
            <div class="list-email">${getValue("E-mail")}</div>
            <div class="list-line">${getValue("LINE")}</div>
        `;
        
        listDiv.appendChild(div);
        
        // 🎯 新增分隔線 <hr>
    });

    renderPagination();
}

    function renderPagination() {
      // ... (這部分邏輯保持不變) ...
      const pageCount = Math.ceil(members.length / pageSize);
      const pagDiv = document.getElementById("pagination");
      pagDiv.innerHTML = "";

      for (let i = 1; i <= pageCount; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        if (i === currentPage) btn.disabled = true;
        btn.addEventListener("click", () => {
          currentPage = i;
          renderPage(currentPage);
        });
        pagDiv.appendChild(btn);
      }
    }

    // 確保頁面載入時檢查登入狀態並嘗試獲取資料
    const token = localStorage.getItem('userToken');
    if (!token) {
        alert("請先登入！");
        window.location.href = "login.html";
    } else {
        fetchMembers();
    }
</script>
</body>
</html>
