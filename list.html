<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>é™½æ˜å±±é’å•†æœƒ-æœƒå“¡é€šè¨ŠéŒ„</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
  <h2 style="text-align: center;">é™½æ˜å±±é’å•†æœƒ-æœƒå“¡é€šè¨ŠéŒ„</h2>
  <div id="memberList">
    <div class="list-r list-h">
            <div class="list-name">
                å§“å
            </div>
            <div class="list-com">æœå‹™å–®ä½</div>
            <div class="list-tel">è¡Œå‹•é›»è©±</div>
            <div class="list-addr">åœ°å€</div>
            <div class="list-email">E-mail</div>
            <div class="list-line">LINE</div>
        </div>
  </div>
  <div id="pagination"></div>
<script src="config.js"></script> 
  <script>
    const pageSize = 10;
    let currentPage = 1;
    let members = [];

    // è¼”åŠ©å‡½å¼ï¼šå°‡ JS ç‰©ä»¶è½‰æ›ç‚º URL æŸ¥è©¢å­—ä¸²
    function encodeData(data) {
        return Object.keys(data).map(key => 
            encodeURIComponent(key) + '=' + encodeURIComponent(data[key])
        ).join('&');
    }

    async function fetchMembers() {
      // ğŸ“Œ æ ¸å¿ƒä¿®æ­£ï¼šæ”¹ç”¨ GET è«‹æ±‚ï¼Œä¸¦å°‡ action åƒæ•¸æ”¾å…¥ URL ä¸­
      const payload = { 
          action: "getList",
          // ğŸ’¡ ç‚ºäº†å¾ŒçºŒè™•ç†ï¼Œé€™è£¡æ‡‰è©²è¦åŠ å…¥æ‚¨åœ¨ç™»å…¥æ™‚å„²å­˜çš„ token
          token: localStorage.getItem('userToken') 
      };
      
      const fullUrl = GAS_URL + '?' + encodeData(payload);

      try {
        // ğŸš€ ä½¿ç”¨ GET è«‹æ±‚ (é€™æ˜¯ GAS doGet å‡½å¼æœ€ç©©å®šçš„æ¥æ”¶æ–¹å¼)
        const resp = await fetch(fullUrl, { method: "GET" });
        
        if (!resp.ok) {
            throw new Error(`HTTP éŒ¯èª¤ç‹€æ…‹: ${resp.status}`);
        }
        
        const result = await resp.json();
        
        // æª¢æŸ¥ GAS å›å‚³çš„ success ç‹€æ…‹ (é€™ä¸€æ­¥éå¸¸é‡è¦ï¼Œå› ç‚ºæˆ‘å€‘çŸ¥é“æ‚¨çš„ GAS æœƒå›å‚³çµæ§‹åŒ–çš„ JSON)
        if (result.success && result.list) {
            members = result.list;
            renderPage(currentPage);
        } else if (result.msg) {
             // è™•ç†æœªæˆæ¬Šæˆ–ä¼ºæœå™¨å›å‚³çš„éŒ¯èª¤è¨Šæ¯
             document.getElementById("memberList").textContent = "éŒ¯èª¤: " + result.msg;
             
             // ğŸ’¡ é¡å¤–è™•ç†ï¼šå¦‚æœæœªæˆæ¬Šï¼Œè·³å›ç™»å…¥é 
             if (result.msg.includes("æœªæˆæ¬Š")) { 
                 alert("æœƒè©±éæœŸæˆ–æœªç™»å…¥ï¼Œè«‹é‡æ–°ç™»å…¥ï¼");
                 window.location.href = "login.html";
             }
        } else {
            throw new Error("ä¼ºæœå™¨å›å‚³æ ¼å¼éŒ¯èª¤æˆ–æœªæä¾›æ¸…å–®ã€‚");
        }
        
      } catch(err) {
        // è™•ç†ç¶²è·¯éŒ¯èª¤æˆ–è§£æéŒ¯èª¤
        document.getElementById("memberList").textContent = "è³‡æ–™è¼‰å…¥å¤±æ•—: " + err.message;
        console.error(err);
      }
    }

   // æ›¿æ›æ‚¨ list.html ä¸­çš„ renderPage(page) å‡½å¼
function renderPage(page) {
    const listDiv = document.getElementById("memberList");
    listDiv.innerHTML = "";

    const start = (page - 1) * pageSize;
    const end = start + pageSize;
    const pageItems = members.slice(start, end);

    pageItems.forEach(member => {
        // 1. ç²å–å”¯ä¸€çš„è­˜åˆ¥ç¢¼ï¼ˆé›»è©±è™Ÿç¢¼ï¼‰ï¼Œç”¨æ–¼å‚³éçµ¦ personal.html
        const phone = member["è¡Œå‹•é›»è©±-å¸³"] || ''; // ç¢ºä¿æ˜¯ç©ºå­—ä¸²è€Œä¸æ˜¯ null/undefined
        
        // 2. æª¢æŸ¥ "æ­¿" æ¬„ä½ï¼Œå¦‚æœå®ƒæœ‰å€¼ï¼Œå‰‡åœ¨å§“åå¾ŒåŠ  *
        const isDeceased = member["æ­¿"] && String(member["æ­¿"]).trim() !== '';
        const nameText = member["å§“å"] || 'N/A';
        const nameDisplay = nameText + (isDeceased ? '*' : '');
        
        // è¼”åŠ©å‡½å¼ï¼šç¢ºä¿ N/A æˆ–ç©ºå€¼ä¸é¡¯ç¤º N/Aï¼Œç•™çµ¦ CSS æ§åˆ¶
        const getValue = (key) => member[key] || ' ';
        
        // ğŸš€ é—œéµä¿®æ­£ï¼šç°¡åŒ–çµæ§‹ï¼Œä¸¦åŠ å…¥ CSS Class
        const div = document.createElement("div");
        div.className = "list-r"; // é ‚å±¤ div çš„ class

        // ğŸ’¡ å…§å±¤ä½¿ç”¨ innerHTML æ‹¼æ¥ï¼Œæ¸›å°‘ DOM æ“ä½œ
        div.innerHTML = `
            <div class="list-name ${isDeceased ? 'deceased-member' : ''}">
                <a href="personal.html?phone=${encodeURIComponent(phone)}">
                    å§“å: ${nameDisplay}
                </a>
            </div>
            <div class="list-com">${getValue("æœå‹™å–®ä½")}</div>
            <div class="list-tel">${getValue("è¡Œå‹•é›»è©±-å¸³")}</div>
            <div class="list-addr">${getValue("é€šè¨Šåœ°å€")}</div>
            <div class="list-email">${getValue("E-mail")}</div>
            <div class="list-line">${getValue("LINE")}</div>
        `;
        
        listDiv.appendChild(div);
        
        // ğŸ¯ æ–°å¢åˆ†éš”ç·š <hr>
    });

    renderPagination();
}

    function renderPagination() {
      // ... (é€™éƒ¨åˆ†é‚è¼¯ä¿æŒä¸è®Š) ...
      const pageCount = Math.ceil(members.length / pageSize);
      const pagDiv = document.getElementById("pagination");
      pagDiv.innerHTML = "";

      for (let i = 1; i <= pageCount; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        if (i === currentPage) btn.disabled = true;
        btn.addEventListener("click", () => {
          currentPage = i;
          renderPage(currentPage);
        });
        pagDiv.appendChild(btn);
      }
    }

    // ç¢ºä¿é é¢è¼‰å…¥æ™‚æª¢æŸ¥ç™»å…¥ç‹€æ…‹ä¸¦å˜—è©¦ç²å–è³‡æ–™
    const token = localStorage.getItem('userToken');
    if (!token) {
        alert("è«‹å…ˆç™»å…¥ï¼");
        window.location.href = "login.html";
    } else {
        fetchMembers();
    }
</script>
</body>
</html>
