<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>æœƒå“¡ç™»å…¥</title>
</head>
<body>
  <h2>æœƒå“¡ç™»å…¥</h2>
  <form id="loginForm">
    <input id="phone" placeholder="è«‹è¼¸å…¥è¡Œå‹•é›»è©±"><br>
    <input id="birthday" placeholder="è«‹è¼¸å…¥ç”Ÿæ—¥(ä¾‹å¦‚0640515)"><br>
    <button type="submit">ç™»å…¥</button>
  </form>
  <div id="loginResult" style="margin-top:12px;"></div>
<!-- AKfycbyvIXS-clVEv78Um5sFNX3wOy7rSU7Xii9cNJjtdpv2iLlEH9zUo5mO8-ldTNFzTy3o_w -->
<script>
    // ------------------------------------------------------------------
    // åŸºç¤è®Šæ•¸èˆ‡è¨­å®š
    // ------------------------------------------------------------------
    const form = document.getElementById('loginForm');
    const resultDiv = document.getElementById('loginResult');
    const LOADING_TEXT = 'è™•ç†ä¸­...';
    // ğŸ’¡ è«‹æ›¿æ›æˆæ‚¨çš„å¯¦éš› /exec URL
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyvIXS-clVEv78Um5sFNX3wOy7rSU7Xii9cNJjtdpv2iLlEH9zUo5mO8-ldTNFzTy3o_w/exec";
    
    // è¼”åŠ©å‡½å¼ï¼šå°‡ JS ç‰©ä»¶è½‰æ›ç‚º URL æŸ¥è©¢å­—ä¸²
    function encodeData(data) {
        return Object.keys(data).map(key => 
            encodeURIComponent(key) + '=' + encodeURIComponent(data[key])
        ).join('&');
    }

    // ------------------------------------------------------------------
    // è¡¨å–®æäº¤äº‹ä»¶è™•ç† (ä½¿ç”¨ Fetch API)
    // ------------------------------------------------------------------
    form.addEventListener('submit', async function(e){
        e.preventDefault();
        
        const submitButton = form.querySelector('button[type="submit"]');
        if (!submitButton) {
             resultDiv.textContent = "éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°æäº¤æŒ‰éˆ•ã€‚";
             return; 
        }

        submitButton.disabled = true;
        resultDiv.textContent = LOADING_TEXT;
        
        const phone = document.getElementById('phone').value.trim();
        const birthday = document.getElementById('birthday').value.trim();

        // æ§‹å»ºè«‹æ±‚åƒæ•¸ (ä¸éœ€è¦ callback åƒæ•¸)
        const payload = { 
            action: "login", 
            phone, 
            birthday
        };
        
        const fullUrl = GAS_URL + '?' + encodeData(payload);

        try {
            // ğŸš€ ä½¿ç”¨ Fetch API ç™¼é€æ¨™æº– GET è«‹æ±‚
            const response = await fetch(fullUrl, { method: 'GET' });
            
            if (!response.ok) {
                // å¦‚æœ HTTP ç‹€æ…‹ç¢¼ä¸æ˜¯ 200 OK
                throw new Error(`ä¼ºæœå™¨éŒ¯èª¤: HTTP ${response.status}`);
            }

            // è®€å–ä¸¦è§£æä¼ºæœå™¨å›å‚³çš„ JSON æ•¸æ“š
            const data = await response.json(); 
            
            // ----------------------------------------------
            // è™•ç†å›å‚³çµæœ (ç™»å…¥æˆåŠŸæˆ–å¤±æ•—)
            // ----------------------------------------------
            if (data && data.success === true && data.token) {
                // æˆåŠŸé‚è¼¯
                localStorage.setItem('userToken', data.token);
                const successMsg = data.msg || 'ç™»å…¥æˆåŠŸ';
                resultDiv.textContent = successMsg + 'ï¼Œæ­£åœ¨è·³è½‰è‡³æœƒå“¡åˆ—è¡¨...';
                
                // è·³è½‰åˆ° LIST.HTML
                setTimeout(() => {
                    window.location.href = "list.html";
                }, 1500);

            } else {
                // å¤±æ•—é‚è¼¯
                localStorage.removeItem('userToken');
                resultDiv.textContent = 'ç™»å…¥å¤±æ•—: ' + ((data && data.msg) || 'æœªçŸ¥éŒ¯èª¤');
            }

        } catch (error) {
            // è™•ç†æ‰€æœ‰ç¶²è·¯éŒ¯èª¤ã€è§£æéŒ¯èª¤æˆ–è‡ªå®šç¾©éŒ¯èª¤
            resultDiv.textContent = `ç¶²è·¯æˆ–ä¼ºæœå™¨éŒ¯èª¤: ${error.message}`;
            localStorage.removeItem('userToken');
        } finally {
            // ç„¡è«–æˆåŠŸæˆ–å¤±æ•—ï¼Œæœ€å¾Œéƒ½è§£é™¤æŒ‰éˆ•ç¦ç”¨
            submitButton.disabled = false;
        }
    });
</script>
</body>
</html>
