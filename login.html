<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>會員登入</title>
</head>
<body>
  <h2>會員登入</h2>
  <form id="loginForm">
    <input id="phone" placeholder="請輸入行動電話"><br>
    <input id="birthday" placeholder="請輸入生日(例如0640515)"><br>
    <button type="submit">登入</button>
  </form>
  <div id="loginResult" style="margin-top:12px;"></div>
<!-- AKfycbyvIXS-clVEv78Um5sFNX3wOy7rSU7Xii9cNJjtdpv2iLlEH9zUo5mO8-ldTNFzTy3o_w -->
<script>
    // ------------------------------------------------------------------
    // 基礎變數與設定
    // ------------------------------------------------------------------
    const form = document.getElementById('loginForm');
    const resultDiv = document.getElementById('loginResult');
    const LOADING_TEXT = '處理中...';
    // 💡 請替換成您的實際 /exec URL
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyvIXS-clVEv78Um5sFNX3wOy7rSU7Xii9cNJjtdpv2iLlEH9zUo5mO8-ldTNFzTy3o_w/exec";
    
    // 輪詢控制變數
    let pollingTimerId = null; 
    let checkCount = 0;
    const MAX_CHECKS = 5; // 最大檢查次數
    const CHECK_INTERVAL = 3000; // 3 秒間隔

    // 輔助函式：將 JS 物件轉換為 URL 查詢字串
    function encodeData(data) {
        return Object.keys(data).map(key => 
            encodeURIComponent(key) + '=' + encodeURIComponent(data[key])
        ).join('&');
    }

    // ------------------------------------------------------------------
    // JSONP 全域回調函式 (處理 GAS 回傳的結果) - 成功執行後會清除輪詢
    // ------------------------------------------------------------------
    window.handleLoginResponse = function(data) {
        const submitButton = form.querySelector('button[type="submit"]');

        // 核心修正：JSONP 腳本一旦執行，立即清除所有定時器
        if (pollingTimerId !== null) {
            clearInterval(pollingTimerId); // 清除 setInterval 或 setTimeout
            clearTimeout(pollingTimerId); // 以防萬一是 setTimeout
            pollingTimerId = null;
        }

        // 立即處理所有狀態更新 (使用 setTimeout(..., 0) 確保優先級)
        setTimeout(() => { 
            if (submitButton) {
                submitButton.disabled = false;
            }

            const scriptElement = document.getElementById('jsonpScript');
            if (scriptElement) {
                scriptElement.remove();
            }
            
            // 檢查回傳的數據狀態
            if (data && data.success === true && data.token) {
                // 成功邏輯
                localStorage.setItem('userToken', data.token);
                const successMsg = data.msg || '登入成功';
                resultDiv.textContent = successMsg + '，正在跳轉至會員列表...';
                
                setTimeout(() => {
                    window.location.href = "list.html";
                }, 1500);

            } else {
                // 失敗邏輯 (顯示來自後端的錯誤訊息)
                localStorage.removeItem('userToken');
                resultDiv.textContent = '登入失敗: ' + ((data && data.msg) || '未知錯誤');
            }
        }, 0); 
    }

    // ------------------------------------------------------------------
    // 定時輪詢函式：檢查 Script 狀態
    // ------------------------------------------------------------------
    function checkScriptStatus() {
        checkCount++;
        const submitButton = form.querySelector('button[type="submit"]');
        const scriptElement = document.getElementById('jsonpScript');

        if (scriptElement && scriptElement.src.startsWith(GAS_URL)) {
            // 情況 1: 腳本已成功加入 DOM (載入完成)
            
            // 🔴 關鍵修正：停止輪詢，不再設定任何長超時
            if (pollingTimerId !== null) {
                clearInterval(pollingTimerId); 
                pollingTimerId = null;
                // 顯示：載入完成，無限期等待執行結果... (我們信任它會執行)
                resultDiv.textContent = '載入完成，等待伺服器回覆執行結果...';
            }
            // 腳本已在 DOM 中，程式碼會被執行。如果執行被極度延遲，畫面會停在「載入完成...」

        } else if (checkCount >= MAX_CHECKS) {
            // 情況 2: 超過最大檢查次數 (15 秒)
            clearInterval(pollingTimerId);
            pollingTimerId = null;
            
            // 顯示最終錯誤 (這表示腳本根本沒被加入 DOM)
            resultDiv.textContent = '網路連線異常，腳本無法載入。請檢查網路或重試。';
            if (submitButton) {
                submitButton.disabled = false;
            }
        } else {
            // 情況 3: 腳本尚未加入 DOM，繼續等待
            resultDiv.textContent = `${LOADING_TEXT} (第 ${checkCount} 次檢查...)`;
        }
    }

    // ------------------------------------------------------------------
    // 表單提交事件處理 (保持不變)
    // ------------------------------------------------------------------
    form.addEventListener('submit', function(e){
        e.preventDefault();
        
        const submitButton = form.querySelector('button[type="submit"]');
        if (!submitButton) {
             resultDiv.textContent = "錯誤：找不到提交按鈕。";
             return; 
        }

        submitButton.disabled = true;
        resultDiv.textContent = LOADING_TEXT;
        checkCount = 0; // 重設計數器

        try {
            const phone = document.getElementById('phone').value.trim();
            const birthday = document.getElementById('birthday').value.trim();

            const payload = { 
                action: "login", 
                phone, 
                birthday,
                callback: "handleLoginResponse" 
            };
            
            const script = document.createElement('script');
            script.src = GAS_URL + '?' + encodeData(payload);
            script.id = 'jsonpScript';
            document.head.appendChild(script);

            // 啟動定時輪詢，開始檢查腳本狀態
            pollingTimerId = setInterval(checkScriptStatus, CHECK_INTERVAL);

        } catch (error) {
            // 捕獲並顯示執行錯誤
            resultDiv.textContent = `🚨 前端執行錯誤：${error.message}`;
            submitButton.disabled = false;
            if (pollingTimerId !== null) {
                clearInterval(pollingTimerId);
                pollingTimerId = null;
            }
        }
    });
</script>
</body>
</html>
