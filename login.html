<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>æœƒå“¡ç™»å…¥</title>
</head>
<body>
  <h2>æœƒå“¡ç™»å…¥</h2>
  <form id="loginForm">
    <input id="phone" placeholder="è«‹è¼¸å…¥è¡Œå‹•é›»è©±"><br>
    <input id="birthday" placeholder="è«‹è¼¸å…¥ç”Ÿæ—¥(ä¾‹å¦‚0640515)"><br>
    <button type="submit">ç™»å…¥</button>
  </form>
  <div id="loginResult" style="margin-top:12px;"></div>
<!-- AKfycbyvIXS-clVEv78Um5sFNX3wOy7rSU7Xii9cNJjtdpv2iLlEH9zUo5mO8-ldTNFzTy3o_w -->
<script>
    // ------------------------------------------------------------------
    // åŸºç¤è®Šæ•¸èˆ‡è¨­å®š
    // ------------------------------------------------------------------
    const form = document.getElementById('loginForm');
    const resultDiv = document.getElementById('loginResult');
    const LOADING_TEXT = 'è™•ç†ä¸­...';
    // ğŸ’¡ è«‹æ›¿æ›æˆæ‚¨çš„å¯¦éš› /exec URL
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyvIXS-clVEv78Um5sFNX3wOy7rSU7Xii9cNJjtdpv2iLlEH9zUo5mO8-ldTNFzTy3o_w/exec";
    
    // è¼ªè©¢æ§åˆ¶è®Šæ•¸
    let pollingTimerId = null; 
    let checkCount = 0;
    const MAX_CHECKS = 5; // æœ€å¤§æª¢æŸ¥æ¬¡æ•¸
    const CHECK_INTERVAL = 3000; // 3 ç§’é–“éš”

    // è¼”åŠ©å‡½å¼ï¼šå°‡ JS ç‰©ä»¶è½‰æ›ç‚º URL æŸ¥è©¢å­—ä¸²
    function encodeData(data) {
        return Object.keys(data).map(key => 
            encodeURIComponent(key) + '=' + encodeURIComponent(data[key])
        ).join('&');
    }

    // ------------------------------------------------------------------
    // JSONP å…¨åŸŸå›èª¿å‡½å¼ (è™•ç† GAS å›å‚³çš„çµæœ) - æˆåŠŸåŸ·è¡Œå¾Œæœƒæ¸…é™¤è¼ªè©¢
    // ------------------------------------------------------------------
    window.handleLoginResponse = function(data) {
        const submitButton = form.querySelector('button[type="submit"]');

        // æ ¸å¿ƒä¿®æ­£ï¼šJSONP è…³æœ¬ä¸€æ—¦åŸ·è¡Œï¼Œç«‹å³æ¸…é™¤è¼ªè©¢è¨ˆæ™‚å™¨
        if (pollingTimerId !== null) {
            clearInterval(pollingTimerId);
            pollingTimerId = null;
        }

        // ç«‹å³è™•ç†æ‰€æœ‰ç‹€æ…‹æ›´æ–° (ä½¿ç”¨ setTimeout(..., 0) ç¢ºä¿å„ªå…ˆç´š)
        setTimeout(() => { 
            if (submitButton) {
                submitButton.disabled = false;
            }

            const scriptElement = document.getElementById('jsonpScript');
            if (scriptElement) {
                scriptElement.remove();
            }
            
            // æª¢æŸ¥å›å‚³çš„æ•¸æ“šç‹€æ…‹
            if (data && data.success === true && data.token) {
                // æˆåŠŸé‚è¼¯
                localStorage.setItem('userToken', data.token);
                const successMsg = data.msg || 'ç™»å…¥æˆåŠŸ';
                resultDiv.textContent = successMsg + 'ï¼Œæ­£åœ¨è·³è½‰è‡³æœƒå“¡åˆ—è¡¨...';
                
                setTimeout(() => {
                    window.location.href = "list.html";
                }, 1500);

            } else {
                // å¤±æ•—é‚è¼¯ (é¡¯ç¤ºä¾†è‡ªå¾Œç«¯çš„éŒ¯èª¤è¨Šæ¯)
                localStorage.removeItem('userToken');
                resultDiv.textContent = 'ç™»å…¥å¤±æ•—: ' + ((data && data.msg) || 'æœªçŸ¥éŒ¯èª¤');
            }
        }, 0); 
    }

    // ------------------------------------------------------------------
    // å®šæ™‚è¼ªè©¢å‡½å¼ï¼šæª¢æŸ¥ Script ç‹€æ…‹
    // ------------------------------------------------------------------
    function checkScriptStatus() {
        checkCount++;
        const submitButton = form.querySelector('button[type="submit"]');
        const scriptElement = document.getElementById('jsonpScript');

        if (scriptElement && scriptElement.src.startsWith(GAS_URL)) {
            // æƒ…æ³ 1: è…³æœ¬å·²æˆåŠŸåŠ å…¥ DOM
            // æ­¤æ™‚æˆ‘å€‘åœæ­¢è¼ªè©¢ï¼Œç­‰å¾…ç€è¦½å™¨åŸ·è¡Œè…³æœ¬ä¸¦å‘¼å« handleLoginResponseã€‚
            if (pollingTimerId !== null) {
                clearInterval(pollingTimerId);
                pollingTimerId = null;
                // æç¤ºï¼šè…³æœ¬å·²è¼‰å…¥ï¼Œç­‰å¾…åŸ·è¡Œçµæœ...
                resultDiv.textContent = 'è¼‰å…¥å®Œæˆï¼Œç­‰å¾…ä¼ºæœå™¨å›è¦†...';
                
                // è¨­ç½®ä¸€å€‹å–®ä¸€çš„é•·è¶…æ™‚ï¼ˆ30ç§’ï¼‰ï¼Œé˜²æ­¢å›èª¿æ°¸é ä¸åŸ·è¡Œã€‚
                // å¦‚æœ 30 ç§’å¾Œä»æœªå‘¼å« handleLoginResponseï¼Œæ‰è¦–ç‚ºçœŸæ­£çš„åŸ·è¡Œå¤±æ•—ã€‚
                pollingTimerId = setTimeout(() => {
                    if (submitButton.disabled) {
                        resultDiv.textContent = 'ç¶²è·¯é€£ç·šç•°å¸¸ï¼Œä¼ºæœå™¨ç„¡å›æ‡‰ã€‚';
                        submitButton.disabled = false;
                    }
                    pollingTimerId = null;
                }, 30000);
            }
        } else if (checkCount >= MAX_CHECKS) {
            // æƒ…æ³ 2: è¶…éæœ€å¤§æª¢æŸ¥æ¬¡æ•¸ (5 æ¬¡ x 3 ç§’ = 15 ç§’)
            clearInterval(pollingTimerId);
            pollingTimerId = null;
            
            // é¡¯ç¤ºæœ€çµ‚éŒ¯èª¤
            resultDiv.textContent = 'ç¶²è·¯é€£ç·šç•°å¸¸ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–é‡è©¦ã€‚';
            if (submitButton) {
                submitButton.disabled = false;
            }
        } else {
            // æƒ…æ³ 3: è…³æœ¬å°šæœªåŠ å…¥ DOMï¼Œç¹¼çºŒç­‰å¾…
            resultDiv.textContent = `${LOADING_TEXT} (ç¬¬ ${checkCount} æ¬¡æª¢æŸ¥...)`;
        }
    }

    // ------------------------------------------------------------------
    // è¡¨å–®æäº¤äº‹ä»¶è™•ç†
    // ------------------------------------------------------------------
    form.addEventListener('submit', function(e){
        e.preventDefault();
        
        const submitButton = form.querySelector('button[type="submit"]');
        if (!submitButton) {
             resultDiv.textContent = "éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°æäº¤æŒ‰éˆ•ã€‚";
             return; 
        }

        submitButton.disabled = true;
        resultDiv.textContent = LOADING_TEXT;
        checkCount = 0; // é‡è¨­è¨ˆæ•¸å™¨

        try {
            // ... (æ§‹å»º Payload ä¿æŒä¸è®Š) ...
            const phone = document.getElementById('phone').value.trim();
            const birthday = document.getElementById('birthday').value.trim();

            const payload = { 
                action: "login", 
                phone, 
                birthday,
                callback: "handleLoginResponse" 
            };
            
            // å‰µå»ºä¸¦é™„åŠ è…³æœ¬æ¨™ç±¤ (ç™¼é€è«‹æ±‚)
            const script = document.createElement('script');
            script.src = GAS_URL + '?' + encodeData(payload);
            script.id = 'jsonpScript';
            document.head.appendChild(script);

            // å•Ÿå‹•å®šæ™‚è¼ªè©¢ï¼Œé–‹å§‹æª¢æŸ¥è…³æœ¬ç‹€æ…‹
            pollingTimerId = setInterval(checkScriptStatus, CHECK_INTERVAL);

        } catch (error) {
            // æ•ç²ä¸¦é¡¯ç¤ºåŸ·è¡ŒéŒ¯èª¤
            resultDiv.textContent = `ğŸš¨ å‰ç«¯åŸ·è¡ŒéŒ¯èª¤ï¼š${error.message}`;
            submitButton.disabled = false;
            if (pollingTimerId !== null) {
                clearInterval(pollingTimerId);
                pollingTimerId = null;
            }
        }
    });
</script>
</body>
</html>
