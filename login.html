<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>æœƒå“¡ç™»å…¥</title>
</head>
<body>
  <h2>æœƒå“¡ç™»å…¥</h2>
  <form id="loginForm">
    <input id="phone" placeholder="è«‹è¼¸å…¥è¡Œå‹•é›»è©±"><br>
    <input id="birthday" placeholder="è«‹è¼¸å…¥ç”Ÿæ—¥(ä¾‹å¦‚0640515)"><br>
    <button type="submit">ç™»å…¥</button>
  </form>
  <div id="loginResult" style="margin-top:12px;"></div>
<!-- AKfycbyvIXS-clVEv78Um5sFNX3wOy7rSU7Xii9cNJjtdpv2iLlEH9zUo5mO8-ldTNFzTy3o_w -->
<script>
    // ------------------------------------------------------------------
    // åŸºç¤è®Šæ•¸èˆ‡è¨­å®š
    // ------------------------------------------------------------------
    const form = document.getElementById('loginForm');
    const resultDiv = document.getElementById('loginResult');
    const LOADING_TEXT = 'è™•ç†ä¸­...';
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyvIXS-clVEv78Um5sFNX3wOy7rSU7Xii9cNJjtdpv2iLlEH9zUo5mO8-ldTNFzTy3o_w/exec";
    
    // è¼”åŠ©è®Šæ•¸ï¼šè¿½è¹¤å›èª¿æ˜¯å¦å·²æˆåŠŸåŸ·è¡Œ
    let isCallbackExecuted = false; 

    function encodeData(data) {
        return Object.keys(data).map(key => 
            encodeURIComponent(key) + '=' + encodeURIComponent(data[key])
        ).join('&');
    }

    // ------------------------------------------------------------------
    // JSONP å…¨åŸŸå›èª¿å‡½å¼ (è®€å–è³‡æ–™ä¸¦æ›´æ–°ç•«é¢)
    // ------------------------------------------------------------------
    window.handleLoginResponse = function(data) {
        // ğŸš€ é€™æ˜¯ç”¨ä¾†è®€å–è³‡æ–™å’Œæ›´æ–°ç•«é¢çš„ç¨‹å¼ç¢¼
        isCallbackExecuted = true; // æ¨™è¨˜å·²åŸ·è¡Œ
        
        const form = document.getElementById('loginForm');
        const resultDiv = document.getElementById('loginResult');
        const submitButton = form ? form.querySelector('button[type="submit"]') : null;
        const scriptElement = document.getElementById('jsonpScript');

        if (submitButton) {
            submitButton.disabled = false;
        }
        if (scriptElement) {
            scriptElement.remove();
        }
        
        // æ ¸å¿ƒé‚è¼¯ï¼šæ ¹æ“š data å…§å®¹æ›´æ–°ç•«é¢
        if (data && data.success === true && data.token) {
            localStorage.setItem('userToken', data.token);
            const successMsg = data.msg || 'ç™»å…¥æˆåŠŸ';
            resultDiv.textContent = successMsg + 'ï¼Œæ­£åœ¨è·³è½‰è‡³æœƒå“¡åˆ—è¡¨...';
            
            setTimeout(() => {
                window.location.href = "list.html";
            }, 1500);

        } else {
            // ç•«é¢é¡¯ç¤ºæ‚¨æœŸå¾…çš„è¨Šæ¯
            localStorage.removeItem('userToken');
            resultDiv.textContent = 'ç™»å…¥å¤±æ•—: ' + ((data && data.msg) || 'æœªçŸ¥éŒ¯èª¤');
        }
    }

    // ------------------------------------------------------------------
    // è¡¨å–®æäº¤äº‹ä»¶è™•ç†
    // ------------------------------------------------------------------
    form.addEventListener('submit', function(e){
        e.preventDefault();
        
        const submitButton = form.querySelector('button[type="submit"]');
        if (!submitButton) {
             resultDiv.textContent = "éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°æäº¤æŒ‰éˆ•ã€‚";
             return; 
        }

        submitButton.disabled = true;
        resultDiv.textContent = LOADING_TEXT;
        isCallbackExecuted = false; // é‡è¨­æ¨™è¨˜
        
        try {
            const phone = document.getElementById('phone').value.trim();
            const birthday = document.getElementById('birthday').value.trim();

            const payload = { 
                action: "login", 
                phone, 
                birthday,
                callback: "handleLoginResponse" 
            };
            
            const script = document.createElement('script');
            script.src = GAS_URL + '?' + encodeData(payload);
            script.id = 'jsonpScript';
            
            // ğŸ”´ é—œéµä¿®æ­£ï¼šåŠ å…¥ onload/onerror ç›£è½å™¨
            // å³ä½¿è…³æœ¬è¢«é˜»æ­¢åŸ·è¡Œï¼Œé€™å€‹ onload ä»æœƒè§¸ç™¼ã€‚
            script.onload = function() {
                // å¦‚æœè…³æœ¬è¼‰å…¥æˆåŠŸï¼Œä½† handleLoginResponse åœ¨çŸ­æ™‚é–“å…§æ²’æœ‰è¢«å‘¼å«
                setTimeout(() => {
                    if (!isCallbackExecuted) {
                        // é€™æ˜¯æœ€çµ‚çš„è¨ºæ–·ï¼Œè¡¨ç¤ºè…³æœ¬å·²è¢«è¼‰å…¥ä½†åŸ·è¡Œè¢«é˜»æ“‹
                        resultDiv.textContent = 'è¼‰å…¥å®Œæˆï¼Œä½†åŸ·è¡Œå¤±æ•—ã€‚è«‹æª¢æŸ¥æ“´å……åŠŸèƒ½æˆ–æ”¹ç”¨ Fetch APIã€‚';
                        submitButton.disabled = false;
                    }
                }, 1000); // çµ¦äºˆ 1 ç§’çš„ç·©è¡æ™‚é–“è®“å›èª¿å‡½å¼åŸ·è¡Œ
            };

            script.onerror = function() {
                // ç¶²è·¯å±¤ç´šçš„éŒ¯èª¤
                resultDiv.textContent = 'ç¶²è·¯é€£ç·šä¸­æ–·æˆ–è³‡æºç„¡æ³•å–å¾—ã€‚';
                submitButton.disabled = false;
            };

            document.head.appendChild(script);

        } catch (error) {
            resultDiv.textContent = `ğŸš¨ å‰ç«¯åŸ·è¡ŒéŒ¯èª¤ï¼š${error.message}`;
            submitButton.disabled = false;
        }
    });
</script>
</body>
</html>
