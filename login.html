<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>æœƒå“¡ç™»å…¥</title>
</head>
<body>
  <h2>æœƒå“¡ç™»å…¥</h2>
  <form id="loginForm">
    <input id="phone" placeholder="è«‹è¼¸å…¥è¡Œå‹•é›»è©±"><br>
    <input id="birthday" placeholder="è«‹è¼¸å…¥ç”Ÿæ—¥(ä¾‹å¦‚0640515)"><br>
    <button type="submit">ç™»å…¥</button>
  </form>
  <div id="loginResult" style="margin-top:12px;"></div>

<script>
    const form = document.getElementById('loginForm');
    const resultDiv = document.getElementById('loginResult');
    // è«‹å‹™å¿…æ›¿æ›æˆæ‚¨éƒ¨ç½²å¾Œçš„å¯¦éš› GAS Web App URL
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwSm2jT9agoCmc0lpTgk1dJ3Z34ZQm2XPHeuc7t_4ILBLoMp_mt-CzHRARaoFV6CokzlA/exec";

    // ğŸ¯ ä¿®æ­£è™•ï¼šæ–°å¢ encodeData å‡½å¼å®šç¾©
    function encodeData(data) {
        return Object.keys(data).map(key => 
            encodeURIComponent(key) + '=' + encodeURIComponent(data[key])
        ).join('&');
    }
    // ------------------------------------------

    // ğŸ”¹ æ­¥é©Ÿ 1: å®šç¾©ä¸€å€‹å…¨åŸŸå›èª¿å‡½å¼ï¼ŒGAS æœƒå‘¼å«å®ƒ
    window.handleLoginResponse = function(data) {
        const resultDiv = document.getElementById('loginResult');
        // æª¢æŸ¥å›å‚³çš„æ•¸æ“š
        if (data && data.success && data.token) {
            localStorage.setItem('userToken', data.token);
            resultDiv.textContent = 'ç™»å…¥æˆåŠŸï¼Œæ­£åœ¨è·³è½‰...';
            // ç¢ºä¿ list.html å­˜åœ¨æ–¼åŒä¸€ç›®éŒ„
            window.location.href = "list.html"; 
        } else {
            resultDiv.textContent = (data && data.msg) || "ç™»å…¥å¤±æ•—";
            localStorage.removeItem('userToken');
        }
        // æ¸…é™¤è…³æœ¬ä»¥é¿å…æ··äº‚
        const scriptElement = document.getElementById('jsonpScript');
        if (scriptElement) {
            scriptElement.remove();
        }
    }

    form.addEventListener('submit', function(e){
        e.preventDefault();
        const phone = document.getElementById('phone').value.trim();
        const birthday = document.getElementById('birthday').value.trim();

        // ğŸ”¹ æ­¥é©Ÿ 2: æ§‹å»º JSONP URL
        const payload = { 
            action: "login", 
            phone, 
            birthday,
            callback: "handleLoginResponse" // å‘Šè¨´ GAS å‘¼å«å“ªå€‹å‡½å¼
        };
        
        // ğŸ”¹ æ­¥é©Ÿ 3: å‰µå»ºè…³æœ¬æ¨™ç±¤ä¾†ç™¼é€è«‹æ±‚
        const script = document.createElement('script');
        script.src = GAS_URL + '?' + encodeData(payload); // é€™è£¡ä¸å†å ±éŒ¯
        script.id = 'jsonpScript';
        document.head.appendChild(script);
    });
</script>
</body>
</html>
