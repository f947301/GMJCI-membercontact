<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>會員登入</title>
</head>
<body>
  <h2>會員登入</h2>
  <form id="loginForm">
    <input id="phone" placeholder="請輸入行動電話"><br>
    <input id="birthday" placeholder="請輸入生日(例如0640515)"><br>
    <button type="submit">登入</button>
  </form>
  <div id="loginResult" style="margin-top:12px;"></div>
<!-- AKfycbyvIXS-clVEv78Um5sFNX3wOy7rSU7Xii9cNJjtdpv2iLlEH9zUo5mO8-ldTNFzTy3o_w -->
<script>
    // ------------------------------------------------------------------
    // 基礎變數與設定
    // ------------------------------------------------------------------
    const form = document.getElementById('loginForm');
    const resultDiv = document.getElementById('loginResult');
    // 💡 請確保這是您部署後最新的 /exec URL
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyvIXS-clVEv78Um5sFNX3wOy7rSU7Xii9cNJjtdpv2iLlEH9zUo5mO8-ldTNFzTy3o_w/exec";
    
    // 儲存超時計時器的 ID
    let timeoutId = null; 

    // 輔助函式：將 JS 物件轉換為 URL 查詢字串
    function encodeData(data) {
        return Object.keys(data).map(key => 
            encodeURIComponent(key) + '=' + encodeURIComponent(data[key])
        ).join('&');
    }

    // ------------------------------------------------------------------
    // JSONP 全域回調函式 (處理 GAS 回傳的結果)
    // ------------------------------------------------------------------
    window.handleLoginResponse = function(data) {
        // 確保在函式內部再次獲取按鈕元素 (增加容錯性)
        const submitButton = form.querySelector('button[type="submit"]');

        // 1. 修正關鍵：清除超時計時器與按鈕禁用狀態
        if (timeoutId !== null) {
            clearTimeout(timeoutId);
            timeoutId = null;
        }
        if (submitButton) {
            submitButton.disabled = false;
        }

        const scriptElement = document.getElementById('jsonpScript');
        if (scriptElement) {
            scriptElement.remove();
        }
        
        // 檢查回傳的數據狀態
        if (data && data.success === true && data.token) {
            // 成功邏輯
            localStorage.setItem('userToken', data.token);
            const successMsg = data.msg || '登入成功';
            resultDiv.textContent = successMsg + '，正在跳轉至會員列表...';
            
            setTimeout(() => {
                window.location.href = "list.html";
            }, 1500);

        } else {
            // 失敗邏輯
            localStorage.removeItem('userToken');
            // 顯示來自後端的錯誤訊息
            resultDiv.textContent = '登入失敗: ' + ((data && data.msg) || '未知錯誤');
        }
    }

    // ------------------------------------------------------------------
    // 表單提交事件處理
    // ------------------------------------------------------------------
    form.addEventListener('submit', function(e){
        e.preventDefault();
        
        // 🔹 修正關鍵：在事件觸發時查找按鈕，防止外部定義錯誤
        const submitButton = form.querySelector('button[type="submit"]');
        
        if (!submitButton) {
             resultDiv.textContent = "錯誤：找不到提交按鈕。";
             return; 
        }

        submitButton.disabled = true;
        resultDiv.textContent = '處理中...'; 

        const phone = document.getElementById('phone').value.trim();
        const birthday = document.getElementById('birthday').value.trim();

        const payload = { 
            action: "login", 
            phone, 
            birthday,
            callback: "handleLoginResponse" 
        };
        
        // 創建腳本標籤來發送請求
        const script = document.createElement('script');
        script.src = GAS_URL + '?' + encodeData(payload);
        script.id = 'jsonpScript';
        
        document.head.appendChild(script);

        // 設定超時機制
        timeoutId = setTimeout(() => {
             // 只有在按鈕仍禁用時執行超時邏輯
             if (submitButton.disabled) {
                resultDiv.textContent = '處理超時 (超過 15 秒)，請檢查網路或重試。';
                submitButton.disabled = false;
                timeoutId = null; 
             }
        }, 15000); 
    });
</script></body>
</html>
