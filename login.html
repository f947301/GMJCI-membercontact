<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>æœƒå“¡ç™»å…¥</title>
</head>
<body>
  <h2>æœƒå“¡ç™»å…¥</h2>
  <form id="loginForm">
    <input id="phone" placeholder="è«‹è¼¸å…¥è¡Œå‹•é›»è©±"><br>
    <input id="birthday" placeholder="è«‹è¼¸å…¥ç”Ÿæ—¥(ä¾‹å¦‚0640515)"><br>
    <button type="submit">ç™»å…¥</button>
  </form>
  <div id="loginResult" style="margin-top:12px;"></div>
<!-- AKfycbyvIXS-clVEv78Um5sFNX3wOy7rSU7Xii9cNJjtdpv2iLlEH9zUo5mO8-ldTNFzTy3o_w -->
<script>
    const form = document.getElementById('loginForm');
    const resultDiv = document.getElementById('loginResult');
    // ğŸ’¡ è«‹ç¢ºä¿é€™æ˜¯æ‚¨éƒ¨ç½²å¾Œæœ€æ–°çš„ /exec URL
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwSm2jT9agoCmc0lpTgk1dJ3Z34ZQm2XPHeuc7t_4ILBLoMp_mt-CzHRARaoFV6CokzlA/exec";
    
    // å„²å­˜è¶…æ™‚è¨ˆæ™‚å™¨çš„ IDï¼Œæ–¹ä¾¿å–æ¶ˆ
    let timeoutId = null; 
    const submitButton = form.querySelector('button[type="submit"]');


    // è¼”åŠ©å‡½å¼ï¼šå°‡ JS ç‰©ä»¶è½‰æ›ç‚º URL æŸ¥è©¢å­—ä¸²
    function encodeData(data) {
        return Object.keys(data).map(key => 
            encodeURIComponent(key) + '=' + encodeURIComponent(data[key])
        ).join('&');
    }

    // ğŸ”¹ JSONP å…¨åŸŸå›èª¿å‡½å¼ (è™•ç† GAS å›å‚³çš„çµæœ)
    window.handleLoginResponse = function(data) {
        // --- ä¿®æ­£é—œéµï¼šç¢ºä¿ç¬¬ä¸€æ™‚é–“æ¸…é™¤è¶…æ™‚è¨ˆæ™‚å™¨èˆ‡æŒ‰éˆ•ç¦ç”¨ç‹€æ…‹ ---
        if (timeoutId !== null) {
            clearTimeout(timeoutId);
            timeoutId = null;
        }
        submitButton.disabled = false;
        // -----------------------------------------------------------

        const scriptElement = document.getElementById('jsonpScript');
        if (scriptElement) {
            scriptElement.remove();
        }
        
        // æª¢æŸ¥å›å‚³çš„æ•¸æ“šç‹€æ…‹
        if (data && data.success === true && data.token) {
            // æˆåŠŸé‚è¼¯
            localStorage.setItem('userToken', data.token);
            const successMsg = data.msg || 'ç™»å…¥æˆåŠŸ';
            resultDiv.textContent = successMsg + 'ï¼Œæ­£åœ¨è·³è½‰è‡³æœƒå“¡åˆ—è¡¨...';
            
            setTimeout(() => {
                window.location.href = "list.html";
            }, 1500);

        } else {
            // å¤±æ•—é‚è¼¯
            localStorage.removeItem('userToken');
            // é¡¯ç¤ºä¾†è‡ªå¾Œç«¯çš„éŒ¯èª¤è¨Šæ¯
            resultDiv.textContent = 'ç™»å…¥å¤±æ•—: ' + ((data && data.msg) || 'æœªçŸ¥éŒ¯èª¤');
        }
    }

    form.addEventListener('submit', function(e){
        e.preventDefault();
        
        // åœ¨è™•ç†é–‹å§‹æ™‚è¨­å®šç‹€æ…‹
        submitButton.disabled = true;
        resultDiv.textContent = 'è™•ç†ä¸­...'; 

        const phone = document.getElementById('phone').value.trim();
        const birthday = document.getElementById('birthday').value.trim();

        const payload = { 
            action: "login", 
            phone, 
            birthday,
            callback: "handleLoginResponse" 
        };
        
        const script = document.createElement('script');
        script.src = GAS_URL + '?' + encodeData(payload);
        script.id = 'jsonpScript';
        
        document.head.appendChild(script);

        // ä¿®æ­£é—œéµï¼šå¢åŠ è¶…æ™‚æ™‚é–“ï¼Œä¸¦ç¢ºä¿åœ¨è¶…æ™‚æ™‚ä¹Ÿèƒ½è§£é™¤æŒ‰éˆ•ç¦ç”¨
        timeoutId = setTimeout(() => {
             // åªæœ‰åœ¨ timeoutId ä»ç„¶æ˜¯æœ‰æ•ˆ ID æ™‚æ‰åŸ·è¡Œè¶…æ™‚é‚è¼¯
             if (submitButton.disabled) {
                resultDiv.textContent = 'è™•ç†è¶…æ™‚ (è¶…é 15 ç§’)ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–é‡è©¦ã€‚';
                submitButton.disabled = false;
                timeoutId = null; 
             }
        }, **30000**); // **15 ç§’è¶…æ™‚**
    });
</script>
</body>
</html>
