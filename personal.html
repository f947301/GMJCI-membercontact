<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>陽明山青商會-會員通訊錄-詳細</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="personalDetail" class="detail-container con">
    </div>
    <div id="message" class="error-message"></div>
    <template id="photoNameTemplate">
        <div class="per-r">
            <div class="per-img">
                <div class="photo-container img-wrap">
                    <div class="img-item">
                        <img src="" alt="會員照片" class="member-photo">
                    </div>
                    <h2 id="pageTitle" class="member-name-title"></h2>
                </div>
            </div>
            <div class="per-contact"></div>
        </div>
    </template>
    <template id="contactItemTemplate">
        <div class="detail-item">
            <div class="per-icon">
                <img src="">
            </div>
            <div class="detail-value"></div>
        </div>
    </template>
    <template id="profileTemplate">
        <div class="per-profile">
            <h3>青商經歷</h3>
            <div class="detail-value"></div>
        </div>
    </template>
    <div class="btn-cus">
        <a href="list.html" class="btn-cus">返回會員列表</a>
    </div>
    <script src="config.js"></script>
    <script>
    // 輔助函式：從 URL 獲取參數
    function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        const results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    };

    // 輔助函式：將 JS 物件轉換為 URL 查詢字串
    function encodeData(data) {
        return Object.keys(data).map(key =>
            encodeURIComponent(key) + '=' + encodeURIComponent(data[key])
        ).join('&');
    }

    /**
     * 將經歷欄位的內容（預期以空格分隔）轉換為帶 <br> 的 HTML 內容。
     */
    function formatExperience(experienceStr) {
        if (!experienceStr) return ''; // 如果沒有資料，返回空字串
        let str = String(experienceStr).trim();
        return str.replace(/\s+/g, '<br>');
    }

    // 修正後的 fetchPersonalDetail 函式
    async function fetchPersonalDetail() {
        const phone = getUrlParameter('phone');
        const token = localStorage.getItem('userToken');
        const msgDiv = document.getElementById("message");
        msgDiv.textContent = "資料載入中..."; // 🎯 修正: 使用 message 顯示載入狀態

        if (!phone) {
            msgDiv.textContent = "錯誤：URL 中缺少會員電話號碼。";
            return;
        }
        if (!token) {
            alert("請先登入！");
            window.location.href = "login.html";
            return;
        }

        // 🎯 移除: document.getElementById("pageTitle").textContent = "會員資料載入中...";
        // 因為此時 pageTitle 元素還不存在於 DOM 中。

        const payload = { action: "getDetail", phone: phone, token: token };
        const fullUrl = GAS_URL + '?' + encodeData(payload);

        try {
            const resp = await fetch(fullUrl, { method: "GET" });

            if (!resp.ok) { throw new Error(`HTTP 錯誤狀態: ${resp.status}`); }

            const result = await resp.json();

            if (result.success && result.detail) {
                msgDiv.textContent = ""; // 載入成功，清空訊息
                renderDetail(result.detail);
            } else if (result.msg) {
                msgDiv.textContent = "錯誤: " + result.msg;
                // 🎯 移除: document.getElementById("pageTitle").textContent = "資料載入失敗";
                if (result.msg.includes("未授權")) {
                    setTimeout(() => { window.location.href = "login.html"; }, 1500);
                }
            } else {
                throw new Error("伺服器回傳格式錯誤或未提供會員詳情。");
            }

        } catch (err) {
            msgDiv.textContent = "資料載入失敗: " + err.message;
            // 🎯 移除: document.getElementById("pageTitle").textContent = "資料載入失敗";
            console.error(err);
        }
    }
    // 🎯 修正後的渲染函式
    // personal.html 中修正後的 renderDetail 函式
    // personal.html 中修正後的 renderDetail 函式 (使用新模板和圖標結構)
    // personal.html 中修正後的 renderDetail 函式 (將經歷移入 per-r 容器)
    function renderDetail(member) {
        const detailDiv = document.getElementById("personalDetail");
        detailDiv.innerHTML = ''; // 清空內容

        // 1. 基本數據與設定
        const DEFAULT_PHOTO_URL = 'assets/profile.png';
        const isDeceased = member["歿"] && String(member["歿"]).trim() !== '';
        const rawName = member["姓名"] || '';
        const nameDisplay = rawName + (isDeceased ? '*' : '');

        // 2. 準備照片/姓名區塊 (photoNameTemplate 包含頂層 per-r 和 per-img)
        const photoNameTemplate = document.getElementById('photoNameTemplate').content.cloneNode(true);
        const perRDiv = photoNameTemplate.querySelector('.per-r'); // 🎯 取得頂層 .per-r 容器
        const perContactDiv = photoNameTemplate.querySelector('.per-contact'); // 抓取聯繫資訊的容器

        // 設置姓名和死亡標記
        const pageTitleElement = photoNameTemplate.querySelector('#pageTitle');
        pageTitleElement.textContent = nameDisplay;
        if (isDeceased) {
            pageTitleElement.classList.add('deceased');
        }

        // 設置圖片 (Base64 或預設圖)
        let photoURL = member["照片URL"];
        if (!photoURL || String(photoURL).trim() === '') {
            photoURL = DEFAULT_PHOTO_URL;
        }
        const imgElement = photoNameTemplate.querySelector('img');
        imgElement.src = photoURL;
        imgElement.alt = rawName ? rawName + '的照片' : '會員照片';


        // 3. 定義聯繫資訊欄位、圖標路徑與 GAS 鍵值
        const contactFields = [
            ["生日", "生日", "cake.png"],
            ["行動電話", "行動電話-帳", "smartphone.png"],
            ["住家電話", "住家電話", "phone-call.png"],
            ["通訊地址", "通訊地址", "location.png"],
            ["E-mail", "E-mail", "email.png"],
            ["LINE", "LINE", "line.png"],
        ];

        const contactItemTemplate = document.getElementById('contactItemTemplate');

        // 渲染聯繫資訊 (單獨項)
        contactFields.forEach(([label, dataKey, iconFile]) => {
            const value = member[dataKey] || '';
            if (value && String(value).trim() !== '') {
                const clone = contactItemTemplate.content.cloneNode(true);
                clone.querySelector('.per-icon img').src = `assets/${iconFile}`;
                clone.querySelector('.detail-value').innerHTML = value;
                perContactDiv.appendChild(clone);
            }
        });

        // 渲染 "服務單位 + 職稱" (合併項)
        const company = member["服務單位"] || '';
        const jobTitle = member["職稱"] || '';
        let jobDisplay = '';

        if (company || jobTitle) {
            jobDisplay = (company ? company : '') + (company && jobTitle ? ' ' : '') + (jobTitle ? jobTitle : '');

            const clone = contactItemTemplate.content.cloneNode(true);
            clone.querySelector('.per-icon img').src = `assets/suitcase.png`;
            clone.querySelector('.detail-value').innerHTML = jobDisplay;
            perContactDiv.appendChild(clone);
        }

        // 4. 渲染經歷區塊
        const experienceValue = formatExperience(member["經歷"]);

        // 🚀 關鍵修正：將經歷模板 clone 後，追加到 .per-r 容器內部
        if (experienceValue && experienceValue.trim() !== '') {
            const profileTemplate = document.getElementById('profileTemplate').content.cloneNode(true);
            profileTemplate.querySelector('.detail-value').innerHTML = experienceValue;

            // 🎯 經歷區塊現在是 per-r 的子元素，跟 per-img 和 per-contact 平級
            perRDiv.appendChild(profileTemplate);
        }

        // 將包含所有內容的 per-r 容器，一次性加入到 detailDiv
        detailDiv.appendChild(photoNameTemplate);
    }

    // 頁面載入時執行
    fetchPersonalDetail();
    </script>
</body>

</html>