<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>æœƒå“¡è©³æƒ…</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <a href="list.html">è¿”å›æœƒå“¡åˆ—è¡¨</a>
    <h2 id="pageTitle" class="member-name-title"></h2>
    <div id="personalDetail" class="detail-container">
    </div>
    <div id="message" class="error-message"></div>
    <template id="photoTemplate">
        <div class="photo-container">
            <img src="" alt="æœƒå“¡ç…§ç‰‡" class="member-photo">
            <hr class="photo-separator">
        </div>
    </template>
    <template id="detailTemplate">
        <div class="detail-item">
            <div class="detail-label"></div>
            <div class="detail-value"></div>
        </div>
    </template>
    <script src="config.js"></script>
    <script>
    // è¼”åŠ©å‡½å¼ï¼šå¾ URL ç²å–åƒæ•¸
    function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        const results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    };

    // è¼”åŠ©å‡½å¼ï¼šå°‡ JS ç‰©ä»¶è½‰æ›ç‚º URL æŸ¥è©¢å­—ä¸²
    function encodeData(data) {
        return Object.keys(data).map(key =>
            encodeURIComponent(key) + '=' + encodeURIComponent(data[key])
        ).join('&');
    }

    /**
     * å°‡ç¶“æ­·æ¬„ä½çš„å…§å®¹ï¼ˆé æœŸä»¥ç©ºæ ¼åˆ†éš”ï¼‰è½‰æ›ç‚ºå¸¶ <br> çš„ HTML å…§å®¹ã€‚
     */
    function formatExperience(experienceStr) {
        if (!experienceStr) return ''; // å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œè¿”å›ç©ºå­—ä¸²
        let str = String(experienceStr).trim();
        return str.replace(/\s+/g, '<br>');
    }

    async function fetchPersonalDetail() {
        const phone = getUrlParameter('phone');
        const token = localStorage.getItem('userToken');
        const msgDiv = document.getElementById("message");
        msgDiv.textContent = "";

        if (!phone) {
            msgDiv.textContent = "éŒ¯èª¤ï¼šURL ä¸­ç¼ºå°‘æœƒå“¡é›»è©±è™Ÿç¢¼ã€‚";
            return;
        }
        if (!token) {
            alert("è«‹å…ˆç™»å…¥ï¼");
            window.location.href = "login.html";
            return;
        }

        // ç¢ºä¿é é¢æ¨™é¡Œåˆå§‹æ™‚é¡¯ç¤ºæ­£ç¢ºç‹€æ…‹
        document.getElementById("pageTitle").textContent = "æœƒå“¡è³‡æ–™è¼‰å…¥ä¸­...";

        const payload = { action: "getDetail", phone: phone, token: token };
        const fullUrl = GAS_URL + '?' + encodeData(payload);

        try {
            const resp = await fetch(fullUrl, { method: "GET" });

            if (!resp.ok) { throw new Error(`HTTP éŒ¯èª¤ç‹€æ…‹: ${resp.status}`); }

            const result = await resp.json();

            if (result.success && result.detail) {
                renderDetail(result.detail);
            } else if (result.msg) {
                msgDiv.textContent = "éŒ¯èª¤: " + result.msg;
                document.getElementById("pageTitle").textContent = "è³‡æ–™è¼‰å…¥å¤±æ•—";
                if (result.msg.includes("æœªæˆæ¬Š")) {
                    setTimeout(() => { window.location.href = "login.html"; }, 1500);
                }
            } else {
                throw new Error("ä¼ºæœå™¨å›å‚³æ ¼å¼éŒ¯èª¤æˆ–æœªæä¾›æœƒå“¡è©³æƒ…ã€‚");
            }

        } catch (err) {
            msgDiv.textContent = "è³‡æ–™è¼‰å…¥å¤±æ•—: " + err.message;
            document.getElementById("pageTitle").textContent = "è³‡æ–™è¼‰å…¥å¤±æ•—";
            console.error(err);
        }
    }

    // ğŸ¯ ä¿®æ­£å¾Œçš„æ¸²æŸ“å‡½å¼
    // personal.html ä¸­ä¿®æ­£å¾Œçš„ renderDetail å‡½å¼
    function renderDetail(member) {
        const detailDiv = document.getElementById("personalDetail");
        detailDiv.innerHTML = ''; // æ¸…ç©ºå…§å®¹

        // 1. å®šç¾©é è¨­åœ–ç‰‡è·¯å¾‘
        // ğŸ’¡ è«‹åœ¨é€™è£¡è¨­ç½®æ‚¨çš„é è¨­åœ–ç‰‡æª”æ¡ˆåç¨±å’Œè·¯å¾‘
        const DEFAULT_PHOTO_URL = 'default_photo.png';

        // å¾åŸå§‹è³‡æ–™ä¸­å–å¾—æ¬„ä½
        const isDeceased = member["æ­¿"] && String(member["æ­¿"]).trim() !== '';
        const rawName = member["å§“å"] || '';
        const nameDisplay = rawName + (isDeceased ? '*' : '');

        // è¨­ç½®ä¸»æ¨™é¡Œ
        document.getElementById("pageTitle").textContent = rawName ? `æœƒå“¡è©³æƒ…ï¼š${nameDisplay}` : 'æœƒå“¡è©³æƒ…';

        // ğŸ¯ 2. è™•ç†ç…§ç‰‡å€å¡Šï¼šå¦‚æœç…§ç‰‡URLæ˜¯ç©ºå­—ä¸²ï¼Œå‰‡ä½¿ç”¨é è¨­åœ–ç‰‡
        let photoURL = member["ç…§ç‰‡URL"];

        // æª¢æŸ¥å¾å¾Œç«¯å›å‚³çš„ Base64 é€£çµæ˜¯å¦ç‚ºç©º
        if (!photoURL || String(photoURL).trim() === '') {
            photoURL = DEFAULT_PHOTO_URL;
        }

        // ç„¡è«–æ˜¯ Base64 é€£çµé‚„æ˜¯é è¨­åœ–ç‰‡ï¼Œæˆ‘å€‘éƒ½é€²è¡Œé¡¯ç¤º
        const photoTemplate = document.getElementById('photoTemplate').content.cloneNode(true);
        const imgElement = photoTemplate.querySelector('img');

        imgElement.src = photoURL;
        imgElement.alt = rawName ? rawName + 'çš„ç…§ç‰‡' : 'æœƒå“¡ç…§ç‰‡';

        detailDiv.appendChild(photoTemplate);


        // 3. å®šç¾©ã€é¡¯ç¤ºæ¨™ç±¤ã€‘èˆ‡ã€GASå›å‚³è³‡æ–™éµå€¼ã€‘çš„å°æ‡‰é—œä¿‚ (ä¿æŒä¸è®Š)
        const fieldsMapping = {
            // é¡¯ç¤ºæ¨™ç±¤: [GASè³‡æ–™éµå€¼, é¡å¤–è™•ç†å‡½å¼ (é¸å¡«)]
            "å§“å": ["å§“å"],
            "ç”Ÿæ—¥": ["ç”Ÿæ—¥"],
            "è·ç¨±": ["è·ç¨±"], // æ–°å¢çš„æ¬„ä½
            "æœå‹™å–®ä½": ["æœå‹™å–®ä½"],
            "è¡Œå‹•é›»è©±": ["è¡Œå‹•é›»è©±-å¸³"],
            "ä½å®¶é›»è©±": ["ä½å®¶é›»è©±"],
            "é€šè¨Šåœ°å€": ["é€šè¨Šåœ°å€"],
            "E-mail": ["E-mail"],
            "LINE": ["LINE"],
            "ç¶“æ­·": ["ç¶“æ­·", formatExperience],
        };

        const itemTemplate = document.getElementById('detailTemplate');

        for (const label in fieldsMapping) {
            const [dataKey, formatter] = fieldsMapping[label];
            let value = member[dataKey] || '';

            if (formatter) {
                value = formatter(value);
            }

            // å¦‚æœå€¼æ˜¯ç©ºå­—ä¸²ï¼Œå‰‡ä¸ç”Ÿæˆæ­¤é …ç›®çš„ HTML
            if (!value || String(value).trim() === '') {
                continue;
            }

            const clone = itemTemplate.content.cloneNode(true);

            clone.querySelector('.detail-label').textContent = label + ':';

            const valueElement = clone.querySelector('.detail-value');
            valueElement.innerHTML = value;

            if (label === 'å§“å' && isDeceased) {
                valueElement.classList.add('deceased');
            }

            detailDiv.appendChild(clone);
        }
    }

    // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
    fetchPersonalDetail();
    </script>
</body>

</html>