<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>æœƒå“¡è©³æƒ…</title>
  <link rel="stylesheet" href="styles.css"> 
</head>
<body>
  <a href="list.html">è¿”å›æœƒå“¡åˆ—è¡¨</a>
  <h2 id="pageTitle" class="member-name-title"></h2> <div id="personalDetail" class="detail-container">
    </div>
  
  <div id="message" class="error-message"></div>

  <template id="photoTemplate">
    <div class="photo-container">
        <img src="" alt="æœƒå“¡ç…§ç‰‡" class="member-photo">
        <hr class="photo-separator">
    </div>
  </template>

  <template id="detailTemplate">
    <div class="detail-item">
        <div class="detail-label"></div> <div class="detail-value"></div> </div>
  </template>

 
 <script src="config.js"></script> 

 <script>
    // è¼”åŠ©å‡½å¼ï¼šå¾ URL ç²å–åƒæ•¸
    function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        const results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    };
    
    // è¼”åŠ©å‡½å¼ï¼šå°‡ JS ç‰©ä»¶è½‰æ›ç‚º URL æŸ¥è©¢å­—ä¸²
    function encodeData(data) {
        return Object.keys(data).map(key => 
            encodeURIComponent(key) + '=' + encodeURIComponent(data[key])
        ).join('&');
    }

    /**
     * å°‡ç¶“æ­·æ¬„ä½çš„å…§å®¹ï¼ˆé æœŸä»¥ç©ºæ ¼åˆ†éš”ï¼‰è½‰æ›ç‚ºå¸¶ <br> çš„ HTML å…§å®¹ã€‚
     */
    function formatExperience(experienceStr) {
        if (!experienceStr) return ''; // å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œè¿”å›ç©ºå­—ä¸²
        let str = String(experienceStr).trim();
        return str.replace(/\s+/g, '<br>'); 
    }

    async function fetchPersonalDetail() {
        const phone = getUrlParameter('phone');
        const token = localStorage.getItem('userToken');
        const msgDiv = document.getElementById("message");
        msgDiv.textContent = "";

        if (!phone) {
            msgDiv.textContent = "éŒ¯èª¤ï¼šURL ä¸­ç¼ºå°‘æœƒå“¡é›»è©±è™Ÿç¢¼ã€‚";
            return;
        }
        if (!token) {
            alert("è«‹å…ˆç™»å…¥ï¼");
            window.location.href = "login.html";
            return;
        }
        
        // ç¢ºä¿é é¢æ¨™é¡Œåˆå§‹æ™‚é¡¯ç¤ºæ­£ç¢ºç‹€æ…‹
        document.getElementById("pageTitle").textContent = "æœƒå“¡è³‡æ–™è¼‰å…¥ä¸­...";

        const payload = { action: "getDetail", phone: phone, token: token };
        const fullUrl = GAS_URL + '?' + encodeData(payload);

        try {
            const resp = await fetch(fullUrl, { method: "GET" });
            
            if (!resp.ok) { throw new Error(`HTTP éŒ¯èª¤ç‹€æ…‹: ${resp.status}`); }
            
            const result = await resp.json();
            
            if (result.success && result.detail) {
                renderDetail(result.detail);
            } else if (result.msg) {
                 msgDiv.textContent = "éŒ¯èª¤: " + result.msg;
                 document.getElementById("pageTitle").textContent = "è³‡æ–™è¼‰å…¥å¤±æ•—";
                 if (result.msg.includes("æœªæˆæ¬Š")) { 
                     setTimeout(() => { window.location.href = "login.html"; }, 1500);
                 }
            } else {
                throw new Error("ä¼ºæœå™¨å›å‚³æ ¼å¼éŒ¯èª¤æˆ–æœªæä¾›æœƒå“¡è©³æƒ…ã€‚");
            }

        } catch(err) {
            msgDiv.textContent = "è³‡æ–™è¼‰å…¥å¤±æ•—: " + err.message;
            document.getElementById("pageTitle").textContent = "è³‡æ–™è¼‰å…¥å¤±æ•—";
            console.error(err);
        }
    }

    // ğŸ¯ ä¿®æ­£å¾Œçš„æ¸²æŸ“å‡½å¼
    function renderDetail(member) {
        const detailDiv = document.getElementById("personalDetail");
        detailDiv.innerHTML = ''; // æ¸…ç©ºå…§å®¹

        const isDeceased = member["æ­¿"] && String(member["æ­¿"]).trim() !== '';
        const rawName = member["å§“å"] || '';
        const nameDisplay = rawName + (isDeceased ? '*' : '');
        
        // è¨­ç½®ä¸»æ¨™é¡Œ (ä¸ä½¿ç”¨æ¨¡æ¿ï¼Œç›´æ¥è¨­ç½®)
        document.getElementById("pageTitle").textContent = rawName ? `æœƒå“¡è©³æƒ…ï¼š${nameDisplay}` : 'æœƒå“¡è©³æƒ…';

        // ğŸ¯ 2. è™•ç†ç…§ç‰‡å€å¡Š (ç„¡è³‡æ–™ä¸é¡¯ç¤º)
        const photoURL = member["ç…§ç‰‡URL"];
        if (photoURL && String(photoURL).trim() !== '') {
            const photoTemplate = document.getElementById('photoTemplate').content.cloneNode(true);
            const imgElement = photoTemplate.querySelector('img');
            
            imgElement.src = photoURL;
            imgElement.alt = rawName ? rawName + 'çš„ç…§ç‰‡' : 'æœƒå“¡ç…§ç‰‡';
            
            detailDiv.appendChild(photoTemplate);
        }

        // 3. å®šç¾©è¦é¡¯ç¤ºçš„æ¬„ä½åŠå…¶å°æ‡‰çš„æ¨™ç±¤
        // ğŸ¯ é—œéµï¼šä½¿ç”¨ä¿®æ­£å¾Œçš„æ¬„ä½åç¨±
        const fieldsMapping = {
            "å§“å": rawName,
            "ç”Ÿæ—¥": member["ç”Ÿæ—¥"] || '', // ğŸ¯ æ¬„ä½ä¿®æ­£ç‚º "ç”Ÿæ—¥"
            "æœå‹™å–®ä½": member["æœå‹™å–®ä½"] || '',
            "è¡Œå‹•é›»è©±": member["è¡Œå‹•é›»è©±"] || '', // ğŸ¯ æ¬„ä½ä¿®æ­£ç‚º "è¡Œå‹•é›»è©±"
            "ä½å®¶é›»è©±": member["ä½å®¶é›»è©±"] || '',
            "é€šè¨Šåœ°å€": member["é€šè¨Šåœ°å€"] || '',
            "E-mail": member["E-mail"] || '',
            "LINE": member["LINE"] || '',
            "ç¶“æ­·": formatExperience(member["ç¶“æ­·"]), // ç¶“æ­·æ–·è¡Œè™•ç†
        };

        const itemTemplate = document.getElementById('detailTemplate');

        for (const label in fieldsMapping) {
            const value = fieldsMapping[label];
            
            // ğŸ¯ é—œéµé‚è¼¯ï¼šå¦‚æœå€¼æ˜¯ç©ºå­—ä¸²ï¼Œå‰‡ä¸ç”Ÿæˆæ­¤é …ç›®çš„ HTML
            if (!value || String(value).trim() === '') {
                continue; 
            }
            
            // å¾æ¨¡æ¿è¤‡è£½ç¯€é»
            const clone = itemTemplate.content.cloneNode(true); 
            
            // è¨­ç½®æ¨™ç±¤
            clone.querySelector('.detail-label').textContent = label + ':';
            
            // è¨­ç½®æ•¸å€¼ (ä½¿ç”¨ innerHTML ä¾†æ¸²æŸ“ <br> æ¨™ç±¤)
            const valueElement = clone.querySelector('.detail-value');
            valueElement.innerHTML = value; 
            
            // æ‡‰ç”¨æ­»äº¡æ¨£å¼ï¼Œäº¤çµ¦ CSS è™•ç†
            if (label === 'å§“å' && isDeceased) {
                valueElement.classList.add('deceased');
            }

            detailDiv.appendChild(clone);
        }
    }

    // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
    fetchPersonalDetail();
  </script>
</body>
</html>