<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>é™½æ˜å±±é’å•†æœƒ-æœƒå“¡é€šè¨ŠéŒ„-è©³ç´°</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="personalDetail" class="detail-container con">
    </div>
    <div id="message" class="error-message"></div>
    <template id="photoNameTemplate">
        <div class="per-r">
            <div class="per-img">
                <div class="photo-container img-wrap">
                    <div class="img-item">
                        <img src="" alt="æœƒå“¡ç…§ç‰‡" class="member-photo">
                    </div>
                    <h2 id="pageTitle" class="member-name-title"></h2>
                </div>
            </div>
            <div class="per-contact"></div>
        </div>
    </template>
    <template id="contactItemTemplate">
        <div class="detail-item">
            <div class="per-icon">
                <img src="">
            </div>
            <div class="detail-value"></div>
        </div>
    </template>
    <template id="profileTemplate">
        <div class="per-profile">
            <h3>é’å•†ç¶“æ­·</h3>
            <div class="detail-value"></div>
        </div>
    </template>
    <div class="btn-cus">
        <a href="list.html" class="btn-cus">è¿”å›æœƒå“¡åˆ—è¡¨</a>
    </div>
    <script src="config.js"></script>
    <script>
    // è¼”åŠ©å‡½å¼ï¼šå¾ URL ç²å–åƒæ•¸
    function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        const results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    };

    // è¼”åŠ©å‡½å¼ï¼šå°‡ JS ç‰©ä»¶è½‰æ›ç‚º URL æŸ¥è©¢å­—ä¸²
    function encodeData(data) {
        return Object.keys(data).map(key =>
            encodeURIComponent(key) + '=' + encodeURIComponent(data[key])
        ).join('&');
    }

    /**
     * å°‡ç¶“æ­·æ¬„ä½çš„å…§å®¹ï¼ˆé æœŸä»¥ç©ºæ ¼åˆ†éš”ï¼‰è½‰æ›ç‚ºå¸¶ <br> çš„ HTML å…§å®¹ã€‚
     */
    function formatExperience(experienceStr) {
        if (!experienceStr) return ''; // å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œè¿”å›ç©ºå­—ä¸²
        let str = String(experienceStr).trim();
        return str.replace(/\s+/g, '<br>');
    }

    // ä¿®æ­£å¾Œçš„ fetchPersonalDetail å‡½å¼
    async function fetchPersonalDetail() {
        const phone = getUrlParameter('phone');
        const token = localStorage.getItem('userToken');
        const msgDiv = document.getElementById("message");
        msgDiv.textContent = "è³‡æ–™è¼‰å…¥ä¸­..."; // ğŸ¯ ä¿®æ­£: ä½¿ç”¨ message é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹

        if (!phone) {
            msgDiv.textContent = "éŒ¯èª¤ï¼šURL ä¸­ç¼ºå°‘æœƒå“¡é›»è©±è™Ÿç¢¼ã€‚";
            return;
        }
        if (!token) {
            alert("è«‹å…ˆç™»å…¥ï¼");
            window.location.href = "login.html";
            return;
        }

        // ğŸ¯ ç§»é™¤: document.getElementById("pageTitle").textContent = "æœƒå“¡è³‡æ–™è¼‰å…¥ä¸­...";
        // å› ç‚ºæ­¤æ™‚ pageTitle å…ƒç´ é‚„ä¸å­˜åœ¨æ–¼ DOM ä¸­ã€‚

        const payload = { action: "getDetail", phone: phone, token: token };
        const fullUrl = GAS_URL + '?' + encodeData(payload);

        try {
            const resp = await fetch(fullUrl, { method: "GET" });

            if (!resp.ok) { throw new Error(`HTTP éŒ¯èª¤ç‹€æ…‹: ${resp.status}`); }

            const result = await resp.json();

            if (result.success && result.detail) {
                msgDiv.textContent = ""; // è¼‰å…¥æˆåŠŸï¼Œæ¸…ç©ºè¨Šæ¯
                renderDetail(result.detail);
            } else if (result.msg) {
                msgDiv.textContent = "éŒ¯èª¤: " + result.msg;
                // ğŸ¯ ç§»é™¤: document.getElementById("pageTitle").textContent = "è³‡æ–™è¼‰å…¥å¤±æ•—";
                if (result.msg.includes("æœªæˆæ¬Š")) {
                    setTimeout(() => { window.location.href = "login.html"; }, 1500);
                }
            } else {
                throw new Error("ä¼ºæœå™¨å›å‚³æ ¼å¼éŒ¯èª¤æˆ–æœªæä¾›æœƒå“¡è©³æƒ…ã€‚");
            }

        } catch (err) {
            msgDiv.textContent = "è³‡æ–™è¼‰å…¥å¤±æ•—: " + err.message;
            // ğŸ¯ ç§»é™¤: document.getElementById("pageTitle").textContent = "è³‡æ–™è¼‰å…¥å¤±æ•—";
            console.error(err);
        }
    }
    // ğŸ¯ ä¿®æ­£å¾Œçš„æ¸²æŸ“å‡½å¼
    // personal.html ä¸­ä¿®æ­£å¾Œçš„ renderDetail å‡½å¼
    // personal.html ä¸­ä¿®æ­£å¾Œçš„ renderDetail å‡½å¼ (ä½¿ç”¨æ–°æ¨¡æ¿å’Œåœ–æ¨™çµæ§‹)
    function renderDetail(member) {
        const detailDiv = document.getElementById("personalDetail");
        detailDiv.innerHTML = ''; // æ¸…ç©ºå…§å®¹

        // 1. åŸºæœ¬æ•¸æ“šèˆ‡è¨­å®š
        const DEFAULT_PHOTO_URL = 'assets/profile.png'; // ğŸ’¡ å‡è¨­æ‚¨çš„é è¨­åœ–åœ¨ assets/profile.png
        const isDeceased = member["æ­¿"] && String(member["æ­¿"]).trim() !== '';
        const rawName = member["å§“å"] || '';
        const nameDisplay = rawName + (isDeceased ? '*' : '');

        // 2. æº–å‚™ç…§ç‰‡/å§“åå€å¡Š
        const photoNameTemplate = document.getElementById('photoNameTemplate').content.cloneNode(true);
        const perContactDiv = photoNameTemplate.querySelector('.per-contact'); // æŠ“å–è¯ç¹«è³‡è¨Šçš„å®¹å™¨

        // è¨­ç½®å§“åå’Œæ­»äº¡æ¨™è¨˜
        const pageTitleElement = photoNameTemplate.querySelector('#pageTitle');
        pageTitleElement.textContent = nameDisplay;
        if (isDeceased) {
            pageTitleElement.classList.add('deceased');
        }

        // è¨­ç½®åœ–ç‰‡ (Base64 æˆ–é è¨­åœ–)
        let photoURL = member["ç…§ç‰‡URL"];
        if (!photoURL || String(photoURL).trim() === '') {
            photoURL = DEFAULT_PHOTO_URL;
        }
        const imgElement = photoNameTemplate.querySelector('img');
        imgElement.src = photoURL;
        imgElement.alt = rawName ? rawName + 'çš„ç…§ç‰‡' : 'æœƒå“¡ç…§ç‰‡';


        // 3. å®šç¾©è¯ç¹«è³‡è¨Šæ¬„ä½ã€åœ–æ¨™è·¯å¾‘èˆ‡ GAS éµå€¼
        // ğŸ’¡ å‡è¨­æ‚¨çš„åœ–æ¨™åœ¨ assets/ ç›®éŒ„ä¸‹
        const contactFields = [
            // [é¡¯ç¤ºæ¨™ç±¤, GASè³‡æ–™éµå€¼, åœ–æ¨™æª”å, é¡å¤–è™•ç†å‡½å¼]
            ["ç”Ÿæ—¥", "ç”Ÿæ—¥", "cake.png"],
            ["è¡Œå‹•é›»è©±", "è¡Œå‹•é›»è©±-å¸³", "smartphone.png"],
            ["ä½å®¶é›»è©±", "ä½å®¶é›»è©±", "phone-call.png"],
            // æœå‹™å–®ä½å’Œè·ç¨±éœ€åˆä½µè™•ç†ï¼Œæ•…ä¸åœ¨é€™è£¡åˆ—å‡º
            ["é€šè¨Šåœ°å€", "é€šè¨Šåœ°å€", "location.png"],
            ["E-mail", "E-mail", "email.png"],
            ["LINE", "LINE", "line.png"],
        ];

        const contactItemTemplate = document.getElementById('contactItemTemplate');

        // æ¸²æŸ“è¯ç¹«è³‡è¨Š (å–®ç¨é …)
        contactFields.forEach(([label, dataKey, iconFile]) => {
            const value = member[dataKey] || '';
            if (value && String(value).trim() !== '') {
                const clone = contactItemTemplate.content.cloneNode(true);
                clone.querySelector('.per-icon img').src = `assets/${iconFile}`;
                clone.querySelector('.detail-value').innerHTML = value;
                perContactDiv.appendChild(clone);
            }
        });

        // æ¸²æŸ“ "æœå‹™å–®ä½ + è·ç¨±" (åˆä½µé …)
        const company = member["æœå‹™å–®ä½"] || '';
        const jobTitle = member["è·ç¨±"] || '';
        let jobDisplay = '';

        if (company || jobTitle) {
            jobDisplay = (company ? company : '') + (company && jobTitle ? ' ' : '') + (jobTitle ? jobTitle : '');

            const clone = contactItemTemplate.content.cloneNode(true);
            clone.querySelector('.per-icon img').src = `assets/suitcase.png`;
            clone.querySelector('.detail-value').innerHTML = jobDisplay;
            perContactDiv.appendChild(clone);
        }

        // 4. æ¸²æŸ“ç¶“æ­·å€å¡Š
        const experienceValue = formatExperience(member["ç¶“æ­·"]);

        detailDiv.appendChild(photoNameTemplate); // å°‡ç…§ç‰‡/è¯çµ¡å€å¡ŠåŠ å…¥åˆ° DOM

        if (experienceValue && experienceValue.trim() !== '') {
            const profileTemplate = document.getElementById('profileTemplate').content.cloneNode(true);
            profileTemplate.querySelector('.detail-value').innerHTML = experienceValue;
            detailDiv.appendChild(profileTemplate);
        }
    }

    // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
    fetchPersonalDetail();
    </script>
</body>

</html>