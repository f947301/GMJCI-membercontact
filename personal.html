<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>æœƒå“¡è©³æƒ…</title>
  <style>
    .detail-container {
        max-width: 600px;
        margin: 20px auto;
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 8px;
    }
    .detail-item {
        margin-bottom: 10px;
        line-height: 1.5;
    }
    .detail-item strong {
        display: inline-block;
        width: 100px;
        color: #333;
    }
    .deceased {
        color: red;
        font-weight: bold;
    }
  </style>
</head>
<body>
  <a href="list.html">è¿”å›æœƒå“¡åˆ—è¡¨</a>
  <h2 id="pageTitle">æœƒå“¡è³‡æ–™è¼‰å…¥ä¸­...</h2>
  <div id="personalDetail" class="detail-container">
    </div>
  <div id="message" style="color: red; margin-top: 20px;"></div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbx04rNTTxPOHn6mAvQAL7MUSwJdR9-LKzA0-ng4Q7PjReGwjdKdzXmPWIINBTGAU5TIyA/exec"; // æ‚¨çš„ GAS URL
    
    // è¼”åŠ©å‡½å¼ï¼šå¾ URL ç²å–åƒæ•¸
    function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        const results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    };
    
    // è¼”åŠ©å‡½å¼ï¼šå°‡ JS ç‰©ä»¶è½‰æ›ç‚º URL æŸ¥è©¢å­—ä¸²
    function encodeData(data) {
        return Object.keys(data).map(key => 
            encodeURIComponent(key) + '=' + encodeURIComponent(data[key])
        ).join('&');
    }

    async function fetchPersonalDetail() {
        const phone = getUrlParameter('phone');
        const token = localStorage.getItem('userToken');
        const detailDiv = document.getElementById("personalDetail");
        const msgDiv = document.getElementById("message");

        if (!phone) {
            msgDiv.textContent = "éŒ¯èª¤ï¼šURL ä¸­ç¼ºå°‘æœƒå“¡é›»è©±è™Ÿç¢¼ã€‚";
            return;
        }
        if (!token) {
            alert("è«‹å…ˆç™»å…¥ï¼");
            window.location.href = "login.html";
            return;
        }

        const payload = { 
            action: "getDetail", // ğŸ¯ ä½¿ç”¨æ–°çš„ GAS å‹•ä½œ
            phone: phone,
            token: token
        };
        
        const fullUrl = GAS_URL + '?' + encodeData(payload);

        try {
            const resp = await fetch(fullUrl, { method: "GET" });
            
            if (!resp.ok) {
                throw new Error(`HTTP éŒ¯èª¤ç‹€æ…‹: ${resp.status}`);
            }
            
            const result = await resp.json();
            
            if (result.success && result.detail) {
                renderDetail(result.detail);
            } else if (result.msg) {
                 msgDiv.textContent = "éŒ¯èª¤: " + result.msg;
                 // å¦‚æœæœªæˆæ¬Šï¼Œè·³å›ç™»å…¥é 
                 if (result.msg.includes("æœªæˆæ¬Š")) { 
                     setTimeout(() => { window.location.href = "login.html"; }, 1500);
                 }
            } else {
                throw new Error("ä¼ºæœå™¨å›å‚³æ ¼å¼éŒ¯èª¤æˆ–æœªæä¾›æœƒå“¡è©³æƒ…ã€‚");
            }

        } catch(err) {
            msgDiv.textContent = "è³‡æ–™è¼‰å…¥å¤±æ•—: " + err.message;
            console.error(err);
        }
    }

    function renderDetail(member) {
        const detailDiv = document.getElementById("personalDetail");
        
        // 1. æª¢æŸ¥ "æ­¿" æ¬„ä½ï¼Œå¦‚æœ‰è³‡æ–™å‰‡åœ¨å§“åå¾Œæ–¹åŠ ä¸Š*å­—
        const isDeceased = member["æ­¿"] && String(member["æ­¿"]).trim() !== '';
        const nameDisplay = member["å§“å"] + (isDeceased ? '*' : '');
        
        // æ›´æ–°æ¨™é¡Œ
        document.getElementById("pageTitle").textContent = `æœƒå“¡è©³æƒ…ï¼š${nameDisplay}`;

        // 2. æ¸²æŸ“è©³æƒ…åˆ—è¡¨
        // ğŸ¯ æ³¨æ„ï¼šæ¬„ä½åç¨±éœ€èˆ‡ Code.gs ä¸­ getMemberDetail è¿”å›çš„æ¬„ä½åç¨±ä¸€è‡´
        const fields = {
            "å§“å": nameDisplay,
            "ç”Ÿæ—¥": member["ç”Ÿæ—¥-å¯†"] || 'N/A', // å‡è¨­é€™æ˜¯ç”Ÿæ—¥æ¬„ä½
            "æœå‹™å–®ä½": member["æœå‹™å–®ä½"] || 'N/A',
            "è¡Œå‹•é›»è©±": member["è¡Œå‹•é›»è©±-å¸³"] || 'N/A',
            "ä½å®¶é›»è©±": member["ä½å®¶é›»è©±"] || 'N/A',
            "é€šè¨Šåœ°å€": member["é€šè¨Šåœ°å€"] || 'N/A',
            "E-mail": member["E-mail"] || 'N/A',
            "LINE": member["LINE"] || 'N/A',
            "ç¶“æ­·": member["ç¶“æ­·"] || 'N/A',
        };

        let htmlContent = '';
        for (const label in fields) {
            // è®“å§“ååœ¨æ­»äº¡æ™‚ç‰¹åˆ¥çªå‡º
            const valueClass = (label === 'å§“å' && isDeceased) ? 'deceased' : '';
            htmlContent += `
                <div class="detail-item">
                    <strong>${label}:</strong> 
                    <span class="${valueClass}">${fields[label]}</span>
                </div>
            `;
        }
        
        detailDiv.innerHTML = htmlContent;
    }

    // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
    fetchPersonalDetail();
  </script>
</body>
</html>